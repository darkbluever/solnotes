
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Druid indexing-service 执行流程梳理 | sol&#39;s notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="sol_catdog">
    

    
    <meta name="description" content="最近在开发、测试 Druid 的 Spark-Batch-Indexing 扩展的时候遇到一点问题：提交离线导入任务以后，overlord 节点的 api 都处于404的状态，无法响应正常请求。为了定位问题，梳理了一下 Druid 的 indexing-service 执行流程，记录如下。">
<meta name="keywords" content="druid">
<meta property="og:type" content="article">
<meta property="og:title" content="Druid indexing-service 执行流程梳理">
<meta property="og:url" content="http://solnotes.com/2018/02/02/druid-indexing-service-workflow/index.html">
<meta property="og:site_name" content="sol&#39;s notes">
<meta property="og:description" content="最近在开发、测试 Druid 的 Spark-Batch-Indexing 扩展的时候遇到一点问题：提交离线导入任务以后，overlord 节点的 api 都处于404的状态，无法响应正常请求。为了定位问题，梳理了一下 Druid 的 indexing-service 执行流程，记录如下。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-02-05T04:48:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Druid indexing-service 执行流程梳理">
<meta name="twitter:description" content="最近在开发、测试 Druid 的 Spark-Batch-Indexing 扩展的时候遇到一点问题：提交离线导入任务以后，overlord 节点的 api 都处于404的状态，无法响应正常请求。为了定位问题，梳理了一下 Druid 的 indexing-service 执行流程，记录如下。">
<meta name="twitter:creator" content="@darkbluever">

    
    <link rel="alternative" href="/atom.xml" title="sol&#39;s notes" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon_s.ico">
    
    
    <link rel="apple-touch-icon" href="/img/apple.jpeg">
    <link rel="apple-touch-icon-precomposed" href="/img/apple.jpeg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="sol&#39;s notes">sol&#39;s notes</a></h1>
				<h2 class="blog-motto">但行善事，莫问前程</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
						<li><a href="/atom.xml">Rss</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:solnotes.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/02/02/druid-indexing-service-workflow/" title="Druid indexing-service 执行流程梳理" itemprop="url">Druid indexing-service 执行流程梳理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="sol_catdog" target="_blank" itemprop="author">sol_catdog</a>
		
  <p class="article-time">
    <time datetime="2018-02-02T12:31:12.000Z" itemprop="datePublished"> 发表于 2018-02-02</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overlord"><span class="toc-number">1.</span> <span class="toc-text">Overlord</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MiddleManager"><span class="toc-number">2.</span> <span class="toc-text">MiddleManager</span></a></li></ol>
		
		</div>
		
		<p>最近在开发、测试 Druid 的 Spark-Batch-Indexing 扩展的时候遇到一点问题：提交离线导入任务以后，overlord 节点的 api 都处于404的状态，无法响应正常请求。为了定位问题，梳理了一下 Druid 的 indexing-service 执行流程，记录如下。</p>
<a id="more"></a>
<h2 id="Overlord"><a href="#Overlord" class="headerlink" title="Overlord"></a>Overlord</h2><p>Overlord 节点负责接收任务，协调和分配任务，为任务创建锁，并返回任务状态给任务发送方。</p>
<p>Overlord 节点在启动后，会初始化一个 event loop（ TaskQueue.start ），TaskQueue 是 Task 生产者和消费者之间的接口，接收的 Task 会基本按照 FIFO 的顺序消费。我们提交一个任务的时候，会发送到 <code>http://&lt;overlord_ip&gt;:&lt;overlord_port&gt;/druid/indexer/v1/task</code>，OverlordResource.taskPost()会处理这个请求，将其写入 TaskQueue。TaskQueue 在执行事件循环主体 manage 的时候，会获取并消费这个任务，在判断 taskIsReady 后，调用RemoteTaskRunner.run() 方法执行 task。后续循环的时候，会判断这个任务是否已经在执行了，以及是否需要 shutdown。</p>
<p>RemoteTaskRunner 在执行 run 方法的时候，会判断接收到的任务的状态， 如果已经在执行了，就直接返回 Future，否则会执行 addPendingTask 方法，加入 PendingTasks Queue，然后触发 runPendingTasks 方法。在 runPendingTasks 方法中，会通过多线程的方式，从 PendingTasks Queue (ConcurrentSkipListMap) 获取 task，然后尝试指派给 worker 执行。此处会先从tryAssignTasks ( ConcurrentMap ) 获取锁，然后根据 worker-select-strategy 选择 worker，然后尝试获取 worker 的锁，并在 ZK 中声明。然后将 task 从 PendingTasks Queue 中移除，写入 RunningTasks Queue，并发出 task status changed 的通知，然后和 ZK 同步 task 状态，在这个 task 开始实际执行之前，不再指派另外的 task，避免超出 worker 的 capacity。</p>
<h2 id="MiddleManager"><a href="#MiddleManager" class="headerlink" title="MiddleManager"></a>MiddleManager</h2><p>middle manager 节点是执行提交任务的工作节点。middle manager 将任务分发到 peons 运行，一个 peon 在一个单独的 jvm 中运行。原因是我们通过单独的 jvm 对任务做资源隔离和日志隔离。一个 peon 在一个时间只能运行一个任务，然而，一个 middle manager 可以管理多个 peon。</p>
<p>middle manager 节点启动后，会初始化一个 Monitor ( WorkerTaskMonitor.start ）, WorkerTaskMonitor 启动时，会注册一些 Listener，包括 RunListener ( ZK )，LocationListener ( TaskRunner )。在有新任务创建、任务状态变更等事件时，会触发这些 Listener 的监听事件，然后会创建相应的 Notice，写入本地的 notices (BlockingQueue)，WorkerTaskMonitor 的 mainLoop 方法会消费 notices 中的事件。</p>
<p>在有新任务创建以后，WorkerTaskMonitor 会创建 RunNotice，消费时，会先将 task 的状态更新为 running，然后调用 ForkingTaskRunner.run() 方法执行任务，并增加 FutureCallback，在任务执行成功或失败后，创建相应的 StatusNotice。ForkingTaskRunner.run() 执行时，会构造一个 java 命令，将 peon 放到一个单独的 jvm 中运行，并保持一个 ProcessHolder 以持有 Process Object，和其输出的 File Object，便于后续使用。在 peon 执行时，ForkingTaskRunner 会同步 peon 的输出，当 peon 执行结束后，根据输出判断执行状态，更新任务状态，销毁 peon 运行所用的资源，释放端口。</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/druid/">druid</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/druid/">druid</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://solnotes.com/2018/02/02/druid-indexing-service-workflow/" data-title="Druid indexing-service 执行流程梳理 | sol&#39;s notes" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/02/05/at-the-beginning-of-2018/" title="at the beginning of 2018">
  <strong>上一篇：</strong><br/>
  <span>
  at the beginning of 2018</span>
</a>
</div>


<div class="next">
<a href="/2017/12/12/druid-sql-floor-add-more-timeunit/"  title="Druid SQL 语法支持更多的查询时聚合时间粒度">
 <strong>下一篇：</strong><br/> 
 <span>Druid SQL 语法支持更多的查询时聚合时间粒度
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overlord"><span class="toc-number">1.</span> <span class="toc-text">Overlord</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MiddleManager"><span class="toc-number">2.</span> <span class="toc-text">MiddleManager</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/数学/" title="数学">数学<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/golang/" title="golang">golang<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/统计学/" title="统计学">统计学<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/monolog/" title="monolog">monolog<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/druid-sql/" title="druid sql">druid sql<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/druid/" title="druid">druid<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hello-world/" title="hello world">hello world<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/mysql-replication/" title="mysql replication">mysql replication<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Quartz/" title="Quartz">Quartz<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/素数/" title="素数">素数<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/A-B-testing/" title="A/B testing">A/B testing<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/svn/" title="svn">svn<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/git/" title="git">git<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/工程/" title="工程">工程<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/tools/" title="tools">tools<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/composer/" title="composer">composer<sup>1</sup></a></li>
			
		
			
		
			
		
			
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  
  <div class="tagcloudlist">
    <p class="asidetitle">标签云</p>
    <div class="tagcloudlist clearfix">
       <a href="/tags/A-B-testing/" style="font-size: 10px;">A/B testing</a> <a href="/tags/Quartz/" style="font-size: 10px;">Quartz</a> <a href="/tags/composer/" style="font-size: 10px;">composer</a> <a href="/tags/druid/" style="font-size: 10px;">druid</a> <a href="/tags/druid-sql/" style="font-size: 10px;">druid sql</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/golang/" style="font-size: 20px;">golang</a> <a href="/tags/hello-world/" style="font-size: 10px;">hello world</a> <a href="/tags/monolog/" style="font-size: 10px;">monolog</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/mysql-replication/" style="font-size: 10px;">mysql replication</a> <a href="/tags/svn/" style="font-size: 10px;">svn</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/工程/" style="font-size: 10px;">工程</a> <a href="/tags/数学/" style="font-size: 20px;">数学</a> <a href="/tags/素数/" style="font-size: 10px;">素数</a> <a href="/tags/统计学/" style="font-size: 10px;">统计学</a>
    </div>
  </div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 技有止 <br/>
			而道无涯</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		<a href="https://github.com/darkbluever" target="_blank" class="icon-github" title="github"></a>
		
		
		
		<a href="https://twitter.com/darkbluever" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		
		
		
		
		
		<a href="mailto:darkbluever@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="sol_catdog">sol_catdog</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'solnotes';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?c9b9ef07a4d0fb90a8b05cfea2df0957";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
